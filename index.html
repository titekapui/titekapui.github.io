<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titek Apui Pro Hybrid | Ali Akbar Dev</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bmkg-blue: #1a2a44; --primary: #e74c3c; --warning: #f1c40f; }
        body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; height: 100%; overflow: hidden; background: #000; }
        
        /* HEADER */
        .header {
            position: absolute; top: 0; left: 0; right: 0; height: 65px;
            background: var(--bmkg-blue); color: white; z-index: 1001;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .brand h1 { margin: 0; font-size: 16px; font-weight: 800; }
        .brand span { color: var(--warning); }
        .head-stats { background: rgba(231, 76, 60, 0.2); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--primary); }
        #count-val { color: var(--primary); font-weight: 800; font-size: 18px; }

        /* SIDEBAR DEFAULT (MOBILE) */
        .sidebar {
            position: absolute; top: 0; left: -320px; width: 280px; height: 100%;
            background: white; z-index: 1005; transition: 0.3s ease;
            box-shadow: 5px 0 25px rgba(0,0,0,0.3); padding: 20px;
            display: flex; flex-direction: column;
        }
        .sidebar.open { left: 0; }
        .menu-toggle { background: none; border: none; color: white; font-size: 20px; cursor: pointer; display: flex; }
        .close-menu { display: flex; align-self: flex-end; font-size: 24px; color: #888; cursor: pointer; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1004; display: none; }
        .overlay.show { display: block; }

        /* DESKTOP OVERRIDE (LAPTOP) */
        @media (min-width: 992px) {
            .menu-toggle, .close-menu { display: none !important; }
            .sidebar { 
                left: 15px !important; top: 80px; width: 310px; height: auto; 
                border-radius: 12px; max-height: 85vh; overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            }
            .overlay { display: none !important; }
            .header { padding-left: 25px; }
        }

        /* UI ELEMENTS */
        .lang-container { display: flex; gap: 5px; margin-bottom: 20px; margin-top: 10px; }
        .lang-btn { 
            flex: 1; padding: 10px; border: 1px solid #ddd; background: #f9f9f9; 
            border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 800;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .lang-btn.active { background: var(--bmkg-blue); color: white; border-color: var(--bmkg-blue); }
        .lang-btn img { width: 16px; border-radius: 2px; }

        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 10px; font-weight: 800; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #eee; font-size: 13px; background: #fff; cursor: pointer; }

        .btn-refresh {
            width: 100%; background: var(--bmkg-blue); color: white; border: none;
            padding: 14px; border-radius: 10px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: auto;
        }

        .locate-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; width: 55px; height: 55px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; border: none; color: var(--bmkg-blue);
        }

        #map { height: 100vh; width: 100%; z-index: 1; }

        .popup-table { width: 100%; font-size: 11px; border-collapse: collapse; margin-top: 8px; }
        .popup-table td { padding: 5px 0; border-bottom: 1px solid #eee; }
        .popup-header { color: var(--primary); font-weight: 800; border-bottom: 2px solid var(--primary); padding-bottom: 4px; }
    </style>
</head>
<body>

<div class="header">
    <button class="menu-toggle" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </button>
    <div class="brand">
        <h1 id="ui-title">TITEK APUI <span>MONITOR</span></h1>
    </div>
    <div class="head-stats">
        <span id="count-val">0</span>
    </div>
</div>

<div class="overlay" id="mapOverlay" onclick="toggleMenu()"></div>

<div class="sidebar" id="sidebarMenu">
    <i class="fas fa-times close-menu" onclick="toggleMenu()"></i>
    
    <div class="lang-container">
        <button class="lang-btn active" id="btn-ace" onclick="setLang('ace')">
            <img src="https://flagcdn.com/w40/tr.png"> ACE
        </button>
        <button class="lang-btn" id="btn-id" onclick="setLang('id')">
            <img src="https://flagcdn.com/w40/id.png"> ID
        </button>
        <button class="lang-btn" id="btn-en" onclick="setLang('en')">
            <img src="https://flagcdn.com/w40/us.png"> EN
        </button>
    </div>

    <div class="control-group">
        <label id="ui-region-lbl">Wilayah Pantauan</label>
        <select id="region-sel" onchange="fetchData(true); if(window.innerWidth < 992) toggleMenu()">
            <option value="aceh">Aceh</option>
            <option value="indonesia">Indonesia</option>
            <option value="global">Global</option>
        </select>
    </div>

    <div class="control-group">
        <label id="ui-sat-lbl">Sensor Satelit</label>
        <select id="sat-sel" onchange="fetchData(true); if(window.innerWidth < 992) toggleMenu()">
            <option value="all">Gabungan Semua Satelit</option>
            <option value="suomi_npp">Suomi NPP (VIIRS)</option>
            <option value="noaa20">NOAA-20 (VIIRS)</option>
            <option value="noaa21">NOAA-21 (VIIRS)</option>
            <option value="terra_aqua">Terra & Aqua (MODIS)</option>
        </select>
    </div>

    <button class="btn-refresh" onclick="fetchData(true); if(window.innerWidth < 992) toggleMenu()">
        <i class="fas fa-sync" id="refresh-icon"></i> <span id="ui-refresh-btn">PEUBARÔ DATA</span>
    </button>
    
    <div style="margin-top:30px; font-size:10px; color:#999; text-align:center; border-top: 1px solid #eee; padding-top: 20px;">
        <div style="font-family:'Dancing Script'; font-size:24px; color:var(--bmkg-blue); margin-bottom:5px;">Ali Akbar</div>
        Samatiga, Aceh Barat
    </div>
</div>

<button class="locate-btn" onclick="locateUser()" title="Lokasi Saya">
    <i class="fas fa-location-crosshairs fa-lg"></i>
</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzH2joEVib8tw81ADlYiwzbe768hCeenfGcGI32GeFr3TiUnAa89Wvi8RjJG5xR5D0/exec";
    
    let currentLang = 'ace';
    let userMarker;
    const translations = {
        ace: { title: "TITEK APUI <span>MONITOR</span>", region: "WILAYAH PANTAUAN", sat: "SENSOR SATELIT", refresh: "PEUBARÔ DATA", detail: "DETAIL LOKASI", loc: "Mita Alamat...", temp: "Suum", energy: "Energi", time: "Waktèe", sat_lbl: "Satelit" },
        id: { title: "MONITORING <span>TITIK API</span>", region: "WILAYAH PANTAUAN", sat: "SENSOR SATELIT", refresh: "PERBARUI DATA", detail: "DETAIL LOKASI", loc: "Mencari Lokasi...", temp: "Suhu", energy: "Energi", time: "Waktu", sat_lbl: "Satelit" },
        en: { title: "HOTSPOT <span>MONITORING</span>", region: "REGION", sat: "SATELLITE", refresh: "REFRESH DATA", detail: "LOCATION DETAIL", loc: "Locating...", temp: "Temp", energy: "Energy", time: "Time", sat_lbl: "Satellite" }
    };

    const map = L.map('map', { zoomControl: false }).setView([4.3, 96.8], 8);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    let fireLayer = L.layerGroup().addTo(map);

    function toggleMenu() {
        if(window.innerWidth < 992) {
            document.getElementById('sidebarMenu').classList.toggle('open');
            document.getElementById('mapOverlay').classList.toggle('show');
        }
    }

    function setLang(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+lang).classList.add('active');
        const t = translations[lang];
        document.getElementById('ui-title').innerHTML = t.title;
        document.getElementById('ui-region-lbl').innerText = t.region;
        document.getElementById('ui-sat-lbl').innerText = t.sat;
        document.getElementById('ui-refresh-btn').innerText = t.refresh;
    }

    function locateUser() {
        const icon = document.querySelector('.locate-btn i');
        icon.className = "fas fa-spinner fa-spin";
        navigator.geolocation.getCurrentPosition((pos) => {
            const { latitude, longitude } = pos.coords;
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([latitude, longitude], { radius: 10, fillColor: '#4285F4', color: 'white', weight: 3, fillOpacity: 1 }).addTo(map);
            map.flyTo([latitude, longitude], 14);
            icon.className = "fas fa-location-crosshairs fa-lg";
        }, () => { alert("Gagal akses lokasi"); icon.className = "fas fa-location-crosshairs fa-lg"; });
    }

    async function fetchData(shouldFly) {
        const sat = document.getElementById('sat-sel').value;
        const region = document.getElementById('region-sel').value;
        const icon = document.getElementById('refresh-icon');
        icon.classList.add('fa-spin');

        try {
            const response = await fetch(`${GAS_URL}?sat=${sat}&wilayah=${region}`);
            const csv = await response.text();
            fireLayer.clearLayers();
            const seenPoints = new Set();

            Papa.parse(csv, {
                header: true, dynamicTyping: true,
                complete: function(res) {
                    res.data.forEach((d, i) => {
                        if (!d.latitude || !d.longitude) return;
                        const pointKey = `${d.latitude.toFixed(4)}|${d.longitude.toFixed(4)}`;
                        if (seenPoints.has(pointKey)) return;
                        seenPoints.add(pointKey);

                        let timeStr = d.acq_time.toString().padStart(4, '0');
                        let dateObj = new Date(d.acq_date);
                        dateObj.setUTCHours(parseInt(timeStr.substring(0, 2)) + 7); 
                        dateObj.setUTCMinutes(parseInt(timeStr.substring(2, 4)));
                        const wibTime = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) + " WIB";
                        const wibDate = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });

                        let satName = "VIIRS";
                        const s = d.satellite;
                        if (s === 'T') satName = "Terra (MODIS)";
                        else if (s === 'A') satName = "Aqua (MODIS)";
                        else if (s === 'N') satName = "Suomi NPP";
                        else if (s === '1' || s === 'J1') satName = "NOAA-20";
                        else if (s === '2' || s === 'J2') satName = "NOAA-21";

                        const color = d.confidence === 'h' || d.confidence > 80 ? '#e74c3c' : '#f39c12';
                        const marker = L.circleMarker([d.latitude, d.longitude], {
                            radius: 9, fillColor: color, color: 'white', weight: 2, fillOpacity: 0.9
                        });

                        const fid = "f-"+i;
                        const t = translations[currentLang];
                        const tempC = ((d.bright_ti4 || d.bright_t31) - 273.15).toFixed(1);

                        marker.bindPopup(() => {
                            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${d.latitude}&lon=${d.longitude}`)
                            .then(r => r.json()).then(data => {
                                const el = document.getElementById(`loc-${fid}`);
                                if(el) el.innerText = data.display_name;
                            });

                            return `
                                <div style="min-width:210px">
                                    <div class="popup-header">${t.detail}</div>
                                    <div id="loc-${fid}" style="font-size:10px; color:#777; margin:8px 0; line-height:1.3;">${t.loc}</div>
                                    <table class="popup-table">
                                        <tr><td>${t.sat_lbl}</td><td align="right"><b>${satName}</b></td></tr>
                                        <tr><td>${t.temp}</td><td align="right">${tempC} °C</td></tr>
                                        <tr><td>${t.energy}</td><td align="right">${d.frp} MW</td></tr>
                                        <tr><td>${t.time}</td><td align="right">${wibDate}, ${wibTime}</td></tr>
                                        <tr><td>Koordinat</td><td align="right">${d.latitude.toFixed(3)}, ${d.longitude.toFixed(3)}</td></tr>
                                    </table>
                                </div>`;
                        });
                        fireLayer.addLayer(marker);
                    });
                    document.getElementById('count-val').innerText = seenPoints.size;
                    if(shouldFly) {
                        if(region==='aceh') map.flyTo([4.3, 96.8], 8);
                        else if(region==='indonesia') map.flyTo([0.78, 113.9], 5);
                    }
                }
            });
        } catch (e) { console.error(e); }
        finally { icon.classList.remove('fa-spin'); }
    }

    window.onload = () => { setLang('ace'); fetchData(false); };
</script>
</body>
</html>
